
#include "common.h"
#include "libxorscura.h"

#include <sys/ptrace.h>


int check_flag_2(char *query){

	//	char *flag_2_plaintext = "9148387e-3835-11e7-954d-ef18177e9fe9";
	unsigned char flag_2_key[] = {0xab,0x52,0xc2,0x50,0x8b,0x34,0x4a,0x46,0xbf,0x5e,0xef,0x24,0x08,0x0d,0x3c,0x08,0xb8,0xcc,0xf5,0x68,0x0d,0x21,0xb0,0x54,0xcb,0x9d,0x36,0x21,0xac,0x20,0x88,0x60,0x48,0x93,0xdd,0x60};
	unsigned char flag_2_ciphertext[] = {0x92,0x63,0xf6,0x68,0xb8,0x0c,0x7d,0x23,0x92,0x6d,0xd7,0x17,0x3d,0x20,0x0d,0x39,0xdd,0xfb,0xd8,0x51,0x38,0x15,0xd4,0x79,0xae,0xfb,0x07,0x19,0x9d,0x17,0xbf,0x05,0x71,0xf5,0xb8,0x59};

	int match = 0;
	struct xod *xor_data;

	if(ptrace(PTRACE_TRACEME, 0, 1, 0) == -1){
		printf("You would try to observe this dark ritual, heretic?! Begone!!\n");
		return(0);
	}

	if((xor_data = (struct xod *) calloc(1, sizeof(struct xod))) == NULL){
		error(-1, errno, "calloc(1, %d)", (int) sizeof(struct xod));
	}

	xor_data->buf_count = BUFFER_LEN;
	xor_data->key_buf = flag_2_key;
	xor_data->ciphertext_buf = flag_2_ciphertext;

	if(xorscura_decrypt(xor_data) == -1){
		error(-1, errno, "xorscura_decrypt(%lx)", (unsigned long) xor_data);
	}

	if(!strncmp((char *) xor_data->plaintext_buf, query, BUFFER_LEN)){
		match = 1;
	}

	xorscura_free_xod(xor_data);
	free(xor_data);

	return(match);
}
